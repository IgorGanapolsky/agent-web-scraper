name: 📬 Email & Publish Reports

on:
  schedule:
    - cron: '15 13 * * *'  # 8:15 AM EST (after daily insight generation)
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  send_and_publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install python-dotenv markdown requests
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-scripts.txt ]; then pip install -r requirements-scripts.txt; fi

      - name: 📧 Send Email Report
        env:
          ZOHO_APP_PASSWORD: ${{ secrets.ZOHO_APP_PASSWORD }}
        run: |
          echo "🚀 Starting email report delivery..."
          python scripts/send_email_report.py
        continue-on-error: true

      - name: 📝 Publish to Substack
        env:
          ZOHO_APP_PASSWORD: ${{ secrets.ZOHO_APP_PASSWORD }}
          SUBSTACK_EMAIL: ${{ secrets.SUBSTACK_EMAIL }}
        run: |
          echo "🚀 Starting Substack publishing..."
          python scripts/publish_substack_post.py
        continue-on-error: true

      - name: 📊 Commit logs if updated
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [[ -n $(git status --porcelain logs/) ]]; then
            git add logs/email_log.csv logs/substack_posts.csv
            git commit -m "📧 Update email and publishing logs" || echo "No log changes to commit"
            git push
          else
            echo "📝 No log changes to commit"
          fi

      - name: 📈 Report Status
        run: |
          echo "✅ Email and publishing workflow completed"
          echo "📊 Check logs for detailed results:"
          if [ -f logs/email_log.csv ]; then
            echo "📧 Email log:"
            tail -n 3 logs/email_log.csv
          fi
          if [ -f logs/substack_posts.csv ]; then
            echo "📝 Substack log:"
            tail -n 3 logs/substack_posts.csv
          fi
